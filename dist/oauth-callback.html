<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OAuth Callback - Onairos</title>
    <style>
        /* Make the callback visually minimal and auto-close quickly.
           The real UX is handled by the parent window via postMessage. */
        body {
            margin: 0;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            color: white;
        }
        .container {
            text-align: center;
            background: rgba(255, 255, 255, 0.95);
            padding: 40px 30px;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            max-width: 400px;
            color: #333;
        }
        .success-icon, .error-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }
        .message {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 10px;
        }
        .details {
            font-size: 14px;
            color: #666;
            margin-bottom: 20px;
        }
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="loading-state">
            <div class="spinner"></div>
            <div class="message">Processing your connection...</div>
            <div class="details">Please wait while we complete the setup.</div>
        </div>
        
        <div id="success-state" style="display: none;">
            <div class="success-icon">‚úÖ</div>
            <div class="message">Successfully Connected!</div>
            <div class="details" id="success-details">You can close this tab now.</div>
        </div>
        
        <div id="error-state" style="display: none;">
            <div class="error-icon">‚ùå</div>
            <div class="message">Connection Failed</div>
            <div class="details" id="error-details">Please try again.</div>
        </div>
    </div>

    <script>
        // Parse URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const success = urlParams.get('success');
        const error = urlParams.get('error');
        const platform = urlParams.get('platform');
        const details = urlParams.get('details');
        const email = urlParams.get('email'); // Extract email from URL params

        // Get elements
        const loadingState = document.getElementById('loading-state');
        const successState = document.getElementById('success-state');
        const errorState = document.getElementById('error-state');
        const errorDetails = document.getElementById('error-details');
        const successDetails = document.getElementById('success-details');

        // Detect if we're in a popup or tab
        const isInPopup = window.opener !== null && !window.opener.closed;
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

        console.log('üîÑ OAuth callback received:', { success, error, platform, details, email, isInPopup, isMobile });

        if (success === 'true' && platform) {
            // Success flow
            console.log(`‚úÖ OAuth success for platform: ${platform}`);
            
            // Show success state
            loadingState.style.display = 'none';
            successState.style.display = 'block';
            
            // Signal success to parent window via localStorage (works across tabs)
            localStorage.setItem(`onairos_${platform}_success`, 'true');
            localStorage.setItem(`onairos_${platform}_timestamp`, Date.now().toString());
            
            // Store email if provided (for Gmail OAuth)
            if (email) {
                localStorage.setItem(`onairos_${platform}_email`, email);
                // Also store as generic oauth_email for compatibility
                localStorage.setItem('onairos_oauth_email', email);
                localStorage.setItem('onairos_gmail_email', email); // Direct key for Gmail
                console.log(`üìß Stored ${platform} email in localStorage:`, email);
            }
            
            // Try to notify parent via postMessage (works for popups)
            try {
                if (window.opener && !window.opener.closed) {
                    window.opener.postMessage({
                        type: 'oauth-success',
                        platform: platform,
                        email: email,
                        gmailEmail: email, // Alias for Gmail
                        success: true
                    }, '*');
                    console.log('üì§ Sent onairos oauth-success postMessage to parent window');
                }
            } catch (e) {
                console.log('‚ö†Ô∏è Could not send postMessage (cross-origin or no opener):', e.message);
            }
            
            // Redirect behavior: 
            // - For popups: close immediately
            // - For same-page redirects (mobile): redirect back to stored return URL
            if (isInPopup) {
                // Popup window - close immediately
                setTimeout(() => {
                    console.log('üö™ Closing OAuth popup window (success)');
                    try {
                        window.close();
                    } catch (e) {
                        console.log('‚ö†Ô∏è Could not close popup:', e.message);
                    }
                }, 100);
            } else {
                // Same-page redirect (mobile) - redirect back to stored return URL
                const returnUrl = localStorage.getItem('onairos_return_url');
                const oauthContext = localStorage.getItem('onairos_oauth_context');
                
                if (returnUrl && (oauthContext === 'gmail-auth' || oauthContext === 'platform-connector')) {
                    console.log('üîÑ Redirecting back to:', returnUrl);
                    successDetails.textContent = 'Redirecting back...';
                    
                    // Clean up return URL from localStorage (component will handle other cleanup)
                    localStorage.removeItem('onairos_return_url');
                    
                    // Redirect back after brief delay to show success message
                    setTimeout(() => {
                        window.location.href = returnUrl;
                    }, 800);
                } else {
                    // Fallback: show message and try to close
                    successDetails.textContent = isMobile 
                        ? 'You can close this tab and return to the app.' 
                        : 'This tab will close automatically.';
                    
                    setTimeout(() => {
                        console.log('üö™ Attempting to close OAuth tab (success, no return URL)');
                        try {
                            window.close();
                            setTimeout(() => {
                                if (!document.hidden) {
                                    successDetails.textContent = 'Please close this tab and return to the app.';
                                    console.log('‚ö†Ô∏è Tab could not be auto-closed (mobile limitation)');
                                }
                            }, 500);
                        } catch (e) {
                            console.log('‚ö†Ô∏è Could not close tab:', e.message);
                            successDetails.textContent = 'Please close this tab and return to the app.';
                        }
                    }, isMobile ? 2000 : 1500);
                }
            }
            
        } else if (error || success === 'false') {
            // Error flow
            console.log(`‚ùå OAuth error for platform: ${platform}`, error);
            
            // Show error state
            loadingState.style.display = 'none';
            errorState.style.display = 'block';
            if (errorDetails) {
                errorDetails.textContent = error || details || 'Please try again.';
            }
            
            // Signal error to parent window
            localStorage.setItem(`onairos_${platform}_error`, error || 'Unknown error');
            localStorage.setItem(`onairos_${platform}_timestamp`, Date.now().toString());
            
            // Try to close on error (works better for popups than tabs)
            setTimeout(() => {
                console.log('üö™ Attempting to close OAuth window (error)');
                try {
                    window.close();
                } catch (e) {
                    console.log('‚ö†Ô∏è Could not close window:', e.message);
                }
            }, 2000);
            
        } else {
            // No clear success or error - treat as potential success
            console.log('ü§î Ambiguous OAuth callback, treating as success');
            
            loadingState.style.display = 'none';
            successState.style.display = 'block';
            successDetails.textContent = 'Processing...';
            
            if (platform) {
                localStorage.setItem(`onairos_${platform}_success`, 'true');
                localStorage.setItem(`onairos_${platform}_timestamp`, Date.now().toString());
            }
            
            // Best-effort close after a short delay
            setTimeout(() => {
                console.log('üö™ Attempting to close OAuth window (ambiguous result)');
                try {
                    window.close();
                } catch (e) {
                    console.log('‚ö†Ô∏è Could not close window:', e.message);
                }
            }, 2000);
        }

        // Fallback: try to close window if no action taken after a longer time
        setTimeout(() => {
            console.log('üö™ Fallback: Attempting to close OAuth window');
            try {
                window.close();
            } catch (e) {
                console.log('‚ö†Ô∏è Fallback: Could not close window:', e.message);
            }
        }, 5000);

        // Handle cases where window.close() might not work
        window.addEventListener('beforeunload', () => {
            console.log('üö™ OAuth popup window closing');
        });
    </script>
</body>
</html> 
</html> 