<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OAuth Callback - Onairos</title>
    <style>
        /* Make the callback visually minimal and auto-close quickly.
           The real UX is handled by the parent window via postMessage. */
        body {
            margin: 0;
            background: transparent;
        }
        .container {
            display: none; /* Hide UI; we just use this page as a silent bridge */
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="loading-state">
            <div class="spinner"></div>
            <div class="message">Processing your connection...</div>
            <div class="details">Please wait while we complete the setup.</div>
        </div>
        
        <div id="success-state" style="display: none;">
            <div class="success-icon">‚úÖ</div>
            <div class="message">Successfully Connected!</div>
            <div class="details">This window will close automatically.</div>
        </div>
        
        <div id="error-state" style="display: none;">
            <div class="error-icon">‚ùå</div>
            <div class="message">Connection Failed</div>
            <div class="details" id="error-details">Please try again.</div>
        </div>
    </div>

    <script>
        // Parse URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const success = urlParams.get('success');
        const error = urlParams.get('error');
        const platform = urlParams.get('platform');
        const details = urlParams.get('details');
        const email = urlParams.get('email'); // Extract email from URL params

        // Get elements
        const loadingState = document.getElementById('loading-state');
        const successState = document.getElementById('success-state');
        const errorState = document.getElementById('error-state');
        const errorDetails = document.getElementById('error-details');

        console.log('üîÑ OAuth callback received:', { success, error, platform, details, email });

        if (success === 'true' && platform) {
            // Success flow
            console.log(`‚úÖ OAuth success for platform: ${platform}`);
            
            // Signal success to parent window
            localStorage.setItem(`onairos_${platform}_success`, 'true');
            localStorage.setItem(`onairos_${platform}_timestamp`, Date.now().toString());
            
            // Store email if provided (for Gmail OAuth)
            if (email) {
                localStorage.setItem(`onairos_${platform}_email`, email);
                // Also store as generic oauth_email for compatibility
                localStorage.setItem('onairos_oauth_email', email);
                localStorage.setItem('onairos_gmail_email', email); // Direct key for Gmail
                console.log(`üìß Stored ${platform} email in localStorage:`, email);
            }
            
            // Try to notify parent (popup / iframe host)
            try {
                if (window.opener && !window.opener.closed) {
                    window.opener.postMessage({
                        type: 'oauth-success',
                        platform: platform,
                        email: email,
                        gmailEmail: email, // Alias for Gmail
                        success: true
                    }, '*');
                    console.log('üì§ Sent onairos oauth-success postMessage to parent window');
                }
            } catch (e) {
                console.log('‚ö†Ô∏è Could not send postMessage (cross-origin):', e.message);
            }
            
            // Immediately attempt to close the popup (no visible success screen)
            setTimeout(() => {
                console.log('üö™ Closing OAuth popup window (success)');
                window.close();
            }, 100);
            
        } else if (error || success === 'false') {
            // Error flow
            console.log(`‚ùå OAuth error for platform: ${platform}`, error);
            
            // Signal error to parent window
            localStorage.setItem(`onairos_${platform}_error`, error || 'Unknown error');
            localStorage.setItem(`onairos_${platform}_timestamp`, Date.now().toString());
            
            // Immediately close on error as well; parent can show its own UI
            setTimeout(() => {
                console.log('üö™ Closing OAuth popup window (error)');
                window.close();
            }, 300);
            
        } else {
            // No clear success or error - treat as potential success
            console.log('ü§î Ambiguous OAuth callback, treating as success');
            
            if (platform) {
                localStorage.setItem(`onairos_${platform}_success`, 'true');
                localStorage.setItem(`onairos_${platform}_timestamp`, Date.now().toString());
            }
            
            // Best-effort close after a short delay
            setTimeout(() => {
                console.log('üö™ Closing OAuth popup window (ambiguous result)');
                window.close();
            }, 300);
        }

        // Fallback: close window if no action taken after a short time
        setTimeout(() => {
            console.log('üö™ Fallback: Closing OAuth popup window');
            window.close();
        }, 2000);

        // Handle cases where window.close() might not work
        window.addEventListener('beforeunload', () => {
            console.log('üö™ OAuth popup window closing');
        });
    </script>
</body>
</html> 