# Onairos API Flow Explained

## Overview
Understanding when to use `combined-training-inference` vs `traits-only` vs `mobile-training/clean`

---

## API Endpoints Breakdown

### 1. `/mobile-training/clean` 
**Route File:** `TempBackend/src/routes/mobileTraining.js`

#### Purpose:
- **Training ONLY** endpoint
- Trains model on user's connected platform data
- Returns trained model (encrypted/compressed)
- Does NOT run inference

#### When to Use:
- ✅ **Non-Wrapped Apps** (like `internship-demo`)
- ✅ When you want to train first, then infer later
- ✅ Mobile SDK / Web SDK training flows
- ✅ When user just connected new platforms

#### Request Format:
```javascript
{
  Info: {
    username: "user@example.com",
    connectedPlatforms: ["Instagram", "YouTube", "ChatGPT"]
  }
}
```

#### Response Format:
```javascript
{
  success: true,
  model: "<encrypted_model_data>",
  traits: [0.85, 0.72, ...], // 16-dim personality vector
  message: "Training complete"
}
```

---

### 2. `/combined-training-inference`
**Route File:** `TempBackend/src/routes/combinedTrainingInference.js`

#### Purpose:
- **Training + Inference** in ONE call
- Returns both traits AND inference results
- Can use cached results OR run fresh inference

#### When to Use:
- ✅ When you need **both** training results AND inference
- ✅ When you have **Input data** for inference
- ✅ When you want complete user profile in one call

#### TWO MODES:

**Mode 1: WITH Input Data (Fresh Inference)**
```javascript
{
  email: "user@example.com",
  Input: "CSV formatted data for inference",
  includeLlmData: true  // Include ChatGPT memories
}
```

**Mode 2: WITHOUT Input Data (Cached Results)**
```javascript
{
  email: "user@example.com",
  includeLlmData: true
}
```

#### Response Format:
```javascript
{
  success: true,
  InferenceResult: {
    traits: [0.85, 0.72, ...],  // 16-dim personality
    personalityDict: {           // Named mapping
      Analyst: 0.85,
      Diplomat: 0.72,
      // ... more traits
    },
    Output: "Inference results...", // If Input provided
    llmData: { ... }  // If includeLlmData: true
  }
}
```

---

### 3. Traits-Only Endpoint (Wrapped Apps)
**Generated by:** `getAPIurlMobile.js` → Returns dynamic URL

#### Purpose:
- **Wrapped dashboard generation**
- Returns personality traits formatted for wrapped experience
- Used by apps like `spotify-wrapped`, `linkedin-wrapped`

#### When to Use:
- ✅ **Wrapped Apps** (name contains "wrapped")
- ✅ When generating personalized dashboards
- ✅ When you want pre-formatted personality insights

#### Flow:
1. User approves data on mobile/web SDK
2. SDK calls `getAPIurlMobile` with:
   ```javascript
   {
     Info: {
       appId: "spotify-wrapped",
       account: "user@example.com",
       confirmations: [{data: "Large"}],
       storage: "s3"
     }
   }
   ```
3. Backend generates dynamic URL (traits-only endpoint)
4. SDK fetches from dynamic URL
5. Returns wrapped dashboard data

---

## Decision Tree

```
┌─────────────────────────────────────────┐
│ What kind of app are you building?     │
└─────────────────────────────────────────┘
                  │
        ┌─────────┴─────────┐
        │                   │
    [Wrapped]          [Non-Wrapped]
        │                   │
        │                   │
        v                   v
┌───────────────┐   ┌──────────────────┐
│ Traits-Only   │   │ mobile-training  │
│ (Dashboard)   │   │ /clean           │
└───────────────┘   └──────────────────┘
        │                   │
        │                   │
        v                   v
┌───────────────┐   ┌──────────────────┐
│ Returns:      │   │ Returns:         │
│ - Traits      │   │ - Trained model  │
│ - Slides      │   │ - Traits         │
│ - Insights    │   │ (No inference)   │
│ - Dashboard   │   └──────────────────┘
└───────────────┘            │
                             │
                    Need inference too?
                             │
                        ┌────┴────┐
                        │   YES   │
                        └─────────┘
                             │
                             v
                  ┌────────────────────────┐
                  │ combined-training-     │
                  │ inference              │
                  └────────────────────────┘
                             │
                             v
                  ┌────────────────────────┐
                  │ Returns:               │
                  │ - Traits               │
                  │ - Inference Results    │
                  │ - LLM Data (optional)  │
                  └────────────────────────┘
```

---

## Current SDK Implementation Issues

### Issue 1: Using Wrong Endpoint for Non-Wrapped Apps
**Location:** `src/onairosButton.jsx` line 830

**Current Code:**
```javascript
// Override for non-wrapped apps (Regular SDK training) to use Training API
if (!isWrappedApp) {
   fetchUrl = 'https://api2.onairos.uk/mobile-training/clean';
   // This only trains, doesn't run inference!
}
```

**Problem:**
- `/mobile-training/clean` only TRAINS the model
- Does NOT run inference
- We need BOTH training AND inference results

**Solution:**
Should use `/combined-training-inference` instead to get both in one call

---

### Issue 2: ChatGPT Connection Not Saving to DB
**Location:** `src/components/ConnectChatGPTModal.jsx` line 5 (bookmarklet)

**Current Bookmarklet Code:**
```javascript
async function sendToBackend(convos,memories){
  try{
    const userData=JSON.parse(localStorage.getItem('onairosUser')||'{}');
    const jwtToken=userData.token;
    
    // ✅ GOOD: Sends to /llm-data/store
    await fetch(`${baseUrl}/llm-data/store`, {
      method:'POST',
      headers:{
        'Content-Type':'application/json',
        'Authorization':`Bearer ${jwtToken}`
      },
      body:JSON.stringify(reqBody)
    });
  }
}
```

**Problem:**
- Bookmarklet correctly sends data to `/llm-data/store`
- But the **user's connectedAccounts array** is NOT updated
- Backend saves LLM data but doesn't update `user.connectedAccounts` field

**What's Missing:**
The backend `/llm-data/store` endpoint should:
1. ✅ Store the LLM data (it does this)
2. ❌ Add "ChatGPT" to user's `connectedAccounts` array (MISSING)

**Backend Fix Needed:**
In `TempBackend/src/routes/llmData.js` (or wherever `/llm-data/store` is):
```javascript
// After storing LLM data, update user's connectedAccounts
await User.findOneAndUpdate(
  { email: userEmail },
  { 
    $addToSet: { 
      connectedAccounts: 'ChatGPT'  // Add if not exists
    }
  }
);
```

---

## Recommended Flow for Non-Wrapped Apps

### Current Flow (Incorrect):
```
1. User connects platforms
2. User sets PIN
3. Training screen shows → calls /mobile-training/clean
4. Training completes → has traits
5. User approves data request
6. ❌ NO INFERENCE RESULTS (only training happened)
```

### Correct Flow (Recommended):
```
1. User connects platforms
2. User sets PIN
3. Training screen shows
4. During loading bar:
   a. Call /mobile-training/clean (training)
   b. Wait for training results
   c. Call /combined-training-inference (inference)
   d. Show "Training complete" + "Running inference"
5. User approves data request
6. ✅ Modal closes with BOTH training + inference results
```

### Alternative Flow (Even Better):
```
1. User connects platforms
2. User sets PIN  
3. Training screen shows
4. During loading bar:
   → Call /combined-training-inference (does BOTH)
   → No need for separate calls!
5. User approves data request
6. ✅ Modal closes with complete results
```

---

## Implementation Recommendations

### For Non-Wrapped Apps:
```javascript
// In TrainingScreen.jsx or onairosButton.jsx

// OPTION 1: Use combined endpoint (BEST)
const response = await fetch('https://api2.onairos.uk/combined-training-inference', {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${token}`,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    email: userData.email,
    includeLlmData: true
  })
});

// OPTION 2: Separate calls (if needed)
// Step 1: Train
const trainingRes = await fetch('https://api2.onairos.uk/mobile-training/clean', {
  method: 'POST',
  headers: { 'Authorization': `Bearer ${token}` },
  body: JSON.stringify({
    Info: {
      username: userData.email,
      connectedPlatforms: connectedAccounts
    }
  })
});

// Step 2: Infer
const inferenceRes = await fetch('https://api2.onairos.uk/combined-training-inference', {
  method: 'POST',
  headers: { 'Authorization': `Bearer ${token}` },
  body: JSON.stringify({
    email: userData.email
  })
});
```

### For Wrapped Apps:
```javascript
// Keep existing flow (works correctly)
// 1. getAPIurlMobile returns traits-only URL
// 2. Fetch from dynamic URL
// 3. Get wrapped dashboard data
```

---

## Summary

| Endpoint | Purpose | Returns | Use Case |
|----------|---------|---------|----------|
| `/mobile-training/clean` | Training only | Model + Traits | When you only need training |
| `/combined-training-inference` | Training + Inference | Traits + Inference + LLM Data | When you need complete profile |
| `traits-only` (dynamic URL) | Wrapped dashboards | Dashboard slides + Insights | Wrapped apps only |

### Key Takeaways:
1. **Non-wrapped apps should use** `/combined-training-inference`
2. **Wrapped apps correctly use** traits-only endpoint
3. **ChatGPT bookmarklet** needs backend fix to update `connectedAccounts`
4. **Training screen** should run BOTH training and inference during loading bar

---

## Next Steps

1. ✅ Update `TrainingScreen.jsx` to call correct endpoint
2. ✅ Make loading bar actually trigger training+inference
3. ✅ Log results to console during loading
4. ⚠️ Backend: Fix `/llm-data/store` to update `connectedAccounts`
5. ⚠️ Backend: Ensure ChatGPT connection persists in user document
